{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>UEnquire Chatbot</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'chatbot/styles/chat.css' %}?{% now "U" %}"">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">




<style>
  .msger-chat {
  
  background-image:url('{% static "chatbot/img/lualhati2.png" %}');
  background-repeat: no-repeat;
  background-position: center;
  /*background-attachment: fixed;*/
  -webkit-background-size: cover;
  -moz-background-size: cover;
  -o-background-size: cover;
  background-size: cover;
}
</style>


</head>


<!-- https://studygyaan.com/python/create-web-based-chatbot-in-python-django-flask -->

  
<body>
  <div class="container-fluid">
  <form method="POST" action="#" class="backForm">
    {% csrf_token %}
    <button type="submit" name="endSessions">Back</button>
  </form>
  <div class="link_flex">
  <div class="link_back">
  <div class="links_header">
    <h4>UE Links</h4>
  </div>
  <div class="table_links">
          <section class="recentTwo">
                    <!-- ------------------------ -->
                    <div class="activity-card_two">
                        <div class="table-responsive table_res">
                            <table class="table">
                                <thead>
                                  <tr>
                                    <th>Links Name</th>
                                    <th>Links URL</th>
                                  </tr>
                                </thead>
                                <tbody class="link_tb">
                                        {% for i in links %}
                                        <tr class="record">
                                          <td data-label="Links Name">{{i.link_name}}</td>
                                          <td data-label="Links URL">{{i.links}}</td>
                                        </tr>
                                        {% endfor %}
                                    
                                </tbody>
                            </table>

                        </div>
                    </div>    
            </section>
  </div>
</div>
</div>

<div class="main_body">



  <!-- partial:index.partial.html -->
<div class="container">
  <section class="msger">
    <header class="msger-header">
      <div class="msger-header-title">
         UEnquire Chatbot 
      </div>
    </header>

    <main class="msger-chat">
      <div class="msg left-msg">
        <div class="msg-img" style="background-image: url(https://image.flaticon.com/icons/svg/327/327779.svg)"></div> 
        <div class="msg-bubble">
          <div class="msg-info">
            <div class="msg-info-name">UEnquire Bot</div>
            <div class="msg-info-time"></div>
          </div>
          <div class="msg-text" id="content">
            Hi {{ request.session.user2 }}, welcome to UEnquire! Go ahead and send me a message. ðŸ˜„
          </div>
        </div>  
      </div>

    </main>
   
    <!-- action="https://www.google.com/search" target="_blank" -->
    <form class="msger-inputarea" id="search-form" method="GET">
      {% csrf_token %}
      
      <input class="msger-input" id="textSearch" type="text" placeholder="Search Google..." autocomplete="off" autofocus name="input_text">
      <button type="button" class="iconClass"><span class="las la-microphone" id="mic"></span></button><button type="submit" name="subSend" id="id_input_user" class="msger-send-btn">Send</button>
      <button type="submit" name="FAQ" id="BtnFAQ" class="msger-faq-btn">FAQ's</button>
    </form>
  </section>
</div>

<div class="main_LostFound">
  <div class="main_contentLost">
    <h4>Lost and Found</h4>
  </div>
</div>


  <!-- partial -->
  <script src='https://use.fontawesome.com/releases/v5.0.13/js/all.js'></script>

  <script>
    var user_visit = "{{ request.session.visits }}"
    if(user_visit != 1){
      document.getElementById("content").innerHTML = "Welcome back to UEnquire! {{ request.session.user2 }} Go ahead and send me a message. ðŸ˜„";
        }


    const msgerForm = get(".msger-inputarea");
    const msgerInput = get(".msger-input");
    const msgerChat = get(".msger-chat");


    // https://drive.google.com/uc?export=view&id=1BoHTz7OiIdemGUvaZCGFE9yagWtEhdmu
    // https://image.flaticon.com/icons/svg/145/145867.svg
    // Icons made by Freepik from www.flaticon.com
    var user_user = "{{ request.session.user2 }}"
    var gende_gender = "{{ request.session.gender }}"
    // console.log(gende_gender)
    const BOT_IMG = "https://image.flaticon.com/icons/svg/327/327779.svg";

    if (gende_gender == "Female"){
      var PERSON_IMG = "https://drive.google.com/uc?export=view&id=1BoHTz7OiIdemGUvaZCGFE9yagWtEhdmu";
    }else{
      var PERSON_IMG = "https://drive.google.com/uc?export=view&id=1C5tsyT0hoCHEltjlffUzSGOTb3Sg6yMK";
    }

    
    const BOT_NAME = "UEnquire Bot";
    const PERSON_NAME = user_user;

    

    document.getElementById("id_input_user").addEventListener("click", event => {
      event.preventDefault();

      const msgText = msgerInput.value;
      if (!msgText) return;

      appendMessage(PERSON_NAME, PERSON_IMG, "right", msgText);
      msgerInput.value = "";
      botResponse(msgText);

      
    });

 // ==========================================NEW Append===============================================
    
    function newAppend(name, img, side){
      const msgCHAT = `
      <div class="msg ${side}-msg">
          <div class="msg-img" style="background-image: url(${img})"></div>
            <div class="msg-bubble">
              <div class="msg-info">
                <div class="msg-info-name">${name}</div>
                <div class="msg-info-time">${formatDate(new Date())}</div>
              </div>
              <div class="msg-text"><p id="new_msg">How can I help you?</p></div>
              <br>
              <div class="butnew" id="demo22">
                <button type="submit" class="input_bot" name="input_text" id="btnNews">News & Updates</button>
                <button type="submit" class="input_bot" name="input_text" id="btnEnroll"> How to enroll</button>
                <button type="submit" class="input_bot" name="input_text" id="btnPayF">How to pay Fees</button>
                <button type="submit" class="input_bot" name="input_text" id="demo">UE Hotline</button>
                <button type="submit" class="input_bot" name="input_text" id="demo1">School Fees</button>
                <button type="submit" class="input_bot" name="input_text" id="demo2">School Calendar</button>
              </div>
          </div>
        </div>
      `;
      msgerChat.insertAdjacentHTML("beforeend", msgCHAT);
      msgerChat.scrollTop += 500;



  // ====================================================================================================

      const dd = document.getElementsByClassName('input_bot');
      Array.from(dd).forEach(element => { 
        element.addEventListener("click", event => {
          event.preventDefault();
          const msgTextTwo =  element.innerText

         if(msgTextTwo === "News & Updates"){

          document.querySelectorAll('#new_msg').forEach(function(title) {
          title.innerHTML = "News & Updates";
            
          });
           
            document.querySelectorAll('#btnEnroll').forEach(function(el) {
                el.innerHTML = "Event";
                });
            document.querySelectorAll('#btnPayF').forEach(function(il) {
               var btnPay = il.innerHTML = "Student Council Event";
                });
            element.innerText = "Announcement";

            var myobj = document.getElementById("demo");
            var myobj1 = document.getElementById("demo1");
            var myobj2 = document.getElementById("demo2");
            myobj.remove();
            myobj1.remove();
            myobj2.remove();

   // ====================================================================================================

            const d2 = document.getElementsByClassName('input_bot');
            Array.from(d2).forEach(element2 => { 
              element2.addEventListener("click", event2 => {
                 const msgText3 =  element2.innerText
                  if(msgText3 === "Student Council Event"){

                      document.querySelectorAll('#btnNews').forEach(function(iil) {
                        var btnPay1 = iil.innerHTML = "CCSS";
                        iil.id = "ccss";
                      });

                      document.querySelectorAll('#btnEnroll').forEach(function(iel) {
                        var btnPay2 = iel.innerHTML = "DENT";
                        iel.id = "dent";
                      });

                      document.querySelectorAll('#btnPayF').forEach(function(ill) {
                        var btnPay3 = ill.innerHTML = "CAS";
                        ill.id = "cas";
                      });


                      const d3 = document.getElementsByClassName('butnew');
                      Array.from(d3).forEach(element3 => { 
                        element3.addEventListener("click", event3 => {

                          var newBut = document.createElement("button");

                         
                           newBut.innerHTML = "CBA";
                           newBut.setAttribute("type", "submit");
                           newBut.classList.add('input_bot')
                           newBut.setAttribute("name", "input_text");
                           newBut.setAttribute("id", "cba");  
                           element3.appendChild(newBut);
// https://stackoverflow.com/questions/4380415/how-can-i-give-a-limit-to-an-append-function-with-javascript/4380487
                          
                         

                          var newBut2 = document.createElement("button");
                          newBut2.innerHTML = "SHS";
                          newBut2.setAttribute("type", "submit");
                          newBut2.classList.add('input_bot')
                          newBut2.setAttribute("name", "input_text");
                          newBut2.setAttribute("id", "shs");
                          element3.appendChild(newBut2);

                          var newBut3 = document.createElement("button");
                          newBut3.innerHTML = "EDUC";
                          newBut3.setAttribute("type", "submit");
                          newBut3.classList.add('input_bot')
                          newBut3.setAttribute("name", "input_text");
                          newBut3.setAttribute("id", "educ");
                          element3.appendChild(newBut3);  

                        }); 
                      });

                    }

                }); 
            });


         } //if 


        }); 
    });


        // ====================================================================================================

    }
    

    //For FAQ's Button
    document.getElementById("BtnFAQ").addEventListener("click", event => {
      event.preventDefault();
      newAppend(BOT_NAME, BOT_IMG, "left");
    });

    function appendMessage(name, img, side, text) {
      //   Simple solution for small apps
      const msgHTML = `
          <div class="msg ${side}-msg">
            
              <div class="msg-img" style="background-image: url(${img})"></div>
              
                <div class="msg-bubble">
                    <div class="msg-info">
                    <div class="msg-info-name">${name}</div>
                    <div class="msg-info-time">${formatDate(new Date())}</div>
                </div>
                  <div class="msg-text"><pre class="pre">${text}</pre></div>
              </div>
            
          </div>
          `;

      msgerChat.insertAdjacentHTML("beforeend", msgHTML);
      msgerChat.scrollTop += 500;

       $(".msg-text").each(function(){
   $(this).html( $(this).html().replace(/((http|https|ftp):\/\/[\w?=&.\/-;#~%-]+(?![\w\s?&.\/;#~%"=-]*>))/g, '<a href="$1">$1</a> ') );
    });
    }

    function botResponse(rawText) {
      var inputText = rawText; 
      var existingTwo = window.localStorage.getItem('UserInput');
      existing = [];
      existing.push(existingTwo);
      existing.push(inputText);
      var newString = existing.join(", ");
      window.localStorage.setItem('UserInput',newString);
      console.log(existing,"<-- sana")
     
      // Bot Respons

      var new_value = window.localStorage.getItem("UserInput");  
      console.log(new_value,"<--- new")


      $.get("/post/{{obj}}/", {input_text: rawText, user_text: new_value}).done(function (data) {
        const msgText = data;
        appendMessage(BOT_NAME, BOT_IMG, "left", msgText);
      });

    }

    // function twitResponse(rawText) {
    //   // Bot Response
    //   $.get("/twitter", {input_text: rawText }).done(function (data) {
    //     const msgText = data;
    //     const str2= msgText+'https://twitter.com/UnivEast';
    //     appendMessage(BOT_NAME, BOT_IMG, "left", str2);
    //     });
    //   }
    // Utils
    function get(selector, root = document) {
      return root.querySelector(selector);
    }

    // TIME 
    function formatDate(date) {
      var hours = date.getHours();
      var minutes = date.getMinutes();
      var ampm = hours >= 12 ? 'pm' : 'am';
      hours = hours % 12;
      hours = hours ? hours : 12; // the hour '0' should be '12'
      minutes = minutes < 10 ? '0'+minutes : minutes;
      var strTime = hours + ':' + minutes + ' ' + ampm;
      return strTime;
    }
    
    
// FOR SPEECH RECOGNITION
const buttonSend = document.getElementById('id_input_user');  
const searchForm = document.querySelector("#search-form");
const searchFormInput = searchForm.querySelector("input"); // <=> document.querySelector("#search-form input");


// The speech recognition interface lives on the browserâ€™s window object
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; // if none exists -> undefined

if(SpeechRecognition){
  console.log("Your Browser supports speech Recognition");
  
  const recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.lang = "fil";

  const micBtn = searchForm.querySelector(".iconClass");
  const micIcon = micBtn.firstElementChild;

  micBtn.addEventListener("click", micBtnClick);
  function micBtnClick() {
    if(micIcon.classList.contains("la-microphone")) { // Start Voice Recognition
      recognition.start(); // First time you have to allow access to mic!
    }
    else {
      recognition.stop();
    }
  }

  recognition.addEventListener("start", startSpeechRecognition); // <=> recognition.onstart = function() {...}
  function startSpeechRecognition() {
    const msgerInput = get(".msger-input");
    micIcon.classList.remove("la-microphone");
    micIcon.classList.add("la-microphone-slash");
    msgerInput.value = "Speaking...";
    searchFormInput.focus();
    console.log("Voice activated, SPEAK");
  }

  recognition.addEventListener("end", endSpeechRecognition); // <=> recognition.onend = function() {...}
  function endSpeechRecognition() {
    const msgerInput = get(".msger-input");
    micIcon.classList.remove("la-microphone-slash");
    micIcon.classList.add("la-microphone");
    msgerInput.value = "";
    searchFormInput.focus();
    console.log("Speech recognition service disconnected");
  }

  recognition.addEventListener("result", resultOfSpeechRecognition); // <=> recognition.onresult = function(event) {...} - Fires when you stop talking
  function resultOfSpeechRecognition(event){
    const msgerInput = get(".msger-input");
    const current = event.resultIndex; 
    const transcript = event.results[current][0].transcript;
    msgerInput.value = transcript;
    console.log(transcript,"<--");
    console.log(current,"<==");

    setTimeout(() => {
      document.getElementById('id_input_user').click();
    }, 750);
  }
  
}
else{
  console.log("Your Browser does not support speech Recognition");
}

  $(".link_tb").each(function(){
   $(this).html( $(this).html().replace(/((http|https|ftp):\/\/[\w?=&.\/-;#~%-]+(?![\w\s?&.\/;#~%"=-]*>))/g, '<a href="$1">$1</a> ') );
  });

  </script>
</div>
</div>
</body>

</html>